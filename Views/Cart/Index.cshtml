@model List<TraSuaFireFox.Models.CartItem>

@{
    ViewData["Title"] = "Giỏ hàng của bạn";
}

<div class="container mx-auto px-4 py-8 max-w-6xl">
    <h1 class="text-3xl font-bold text-amber-700 mb-6 border-b pb-4">
        <i class="fa-solid fa-cart-shopping mr-2"></i> Giỏ Hàng
    </h1>

    @if (Model.Count == 0)
    {
        <div id="empty-cart-message" class="text-center py-12 bg-gray-50 rounded-lg">
            <p class="text-xl text-gray-500 mb-4">Giỏ hàng đang trống trơn...</p>
            <a href="/Menu" class="bg-amber-600 text-white px-6 py-3 rounded-full hover:bg-amber-700 transition font-bold">
                Đi chọn trà sữa ngay
            </a>
        </div>
    }
    else
    {
        <div id="cart-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-amber-50 text-amber-800 uppercase text-xs font-bold">
                            <tr>
                                <th class="px-4 py-3">Sản phẩm</th>
                                <th class="px-4 py-3 text-center">Đơn giá</th>
                                <th class="px-4 py-3 text-center">Số lượng</th>
                                <th class="px-4 py-3 text-center">Thành tiền</th>
                                <th class="px-4 py-3 text-center">Xóa</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            @foreach (var item in Model)
                            {
                                <tr id="row-@item.Masp" class="hover:bg-gray-50 transition">
                                    <td class="px-4 py-4">
                                        <div class="flex items-center gap-3">
                                            <img src="~/images/products/@item.Hinhanh" class="w-16 h-16 object-cover rounded-md border" alt="@item.Tensp">
                                            <div>
                                                <h3 class="font-bold text-gray-800 text-sm">@item.Tensp</h3>
                                                <span class="text-xs text-gray-500">Mã: @item.Masp</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-center font-medium">
                                        @string.Format("{0:N0}", item.Dongia)
                                    </td>
                                    <td class="px-4 py-4 text-center">
                                        <input type="number"
                                               data-id="@item.Masp"
                                               value="@item.Soluong"
                                               min="1"
                                               class="cart-qty-input w-16 text-center border border-gray-300 rounded px-2 py-1 focus:outline-none focus:border-amber-500 transition" />
                                    </td>
                                    <td class="px-4 py-4 text-center font-bold text-amber-600">
                                        <span id="item-total-@item.Masp">@string.Format("{0:N0} đ", item.ThanhTien)</span>
                                    </td>
                                    <td class="px-4 py-4 text-center">
                                        <button class="cart-remove-btn text-red-500 hover:text-red-700 transition" data-id="@item.Masp" title="Xóa món này">
                                            <i class="fa-solid fa-trash-can text-lg"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="mt-6">
                    <a href="/Menu" class="text-amber-600 hover:underline font-medium">
                        <i class="fa-solid fa-arrow-left mr-1"></i> Tiếp tục mua hàng
                    </a>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-white shadow-lg rounded-lg p-6 border border-gray-100 sticky top-24">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Tổng kết đơn hàng</h3>

                    <div class="flex justify-between mb-2 text-gray-600">
                        <span>Tạm tính:</span>
                        <span id="cart-subtotal">@string.Format("{0:N0} đ", ViewBag.TongTien)</span>
                    </div>

                    <div class="border-t border-dashed pt-4 flex justify-between items-center mb-6">
                        <span class="font-bold text-lg">Tổng cộng:</span>
                        <span id="cart-grand-total" class="font-bold text-2xl text-red-600">@string.Format("{0:N0} đ", ViewBag.TongTien)</span>
                    </div>

                    <a href="/Checkout/Index" class="block w-full bg-red-600 text-white text-center py-3 rounded-lg font-bold hover:bg-red-700 transition shadow-lg transform hover:-translate-y-0.5">
                        TIẾN HÀNH THANH TOÁN
                    </a>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Định dạng tiền tệ Việt Nam
            const formatter = new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            });

            // 1. XỬ LÝ THAY ĐỔI SỐ LƯỢNG
            $('.cart-qty-input').on('change', function() {
                var input = $(this);
                var id = input.data('id');
                var qty = input.val();

                if(qty < 1) {
                    qty = 1;
                    input.val(1); // Không cho nhập số âm hoặc 0
                }

                $.post('/Cart/UpdateQuantityAjax', { id: id, quantity: qty }, function(res) {
                    if(res.success) {
                        // Cập nhật thành tiền của món đó
                        $('#item-total-' + id).text(formatter.format(res.itemTotal));

                        // Cập nhật Tổng tiền cả giỏ
                        $('#cart-subtotal').text(formatter.format(res.cartTotal));
                        $('#cart-grand-total').text(formatter.format(res.cartTotal));

                        // Quan trọng: Cập nhật cả Mini-cart trên header (Hàm chúng ta viết ở bước trước)
                        if(typeof updateMiniCart === 'function') {
                            updateMiniCart();
                        }
                    }
                });
            });

            // 2. XỬ LÝ NÚT XÓA
            $('.cart-remove-btn').on('click', function() {
                var btn = $(this);
                var id = btn.data('id');

                if(confirm('Bạn có chắc muốn xóa món này?')) {
                    $.post('/Cart/RemoveCartAjax', { id: id }, function(res) {
                        if(res.success) {
                            // Xóa dòng HTML (Hiệu ứng fade out)
                            $('#row-' + id).fadeOut(300, function() {
                                $(this).remove();

                                // Sau khi xóa dòng, cập nhật lại Mini-cart để lấy lại tổng tiền mới nhất
                                // (Hoặc có thể gọi API GetCartJson để lấy lại total)
                                if(typeof updateMiniCart === 'function') {
                                    updateMiniCart(); // Hàm này sẽ tự cập nhật lại số tiền trên icon và trong list

                                    // Cập nhật lại tổng tiền trang giỏ hàng (Lấy từ API của MiniCart hoặc reload)
                                    // Cách đơn giản nhất để đồng bộ 100% là reload nếu giỏ hàng trống,
                                    // hoặc gọi GetCartJson để update text.
                                    $.get('/Cart/GetCartJson', function(data) {
                                        if(data.count === 0) {
                                            location.reload(); // Reload để hiện thông báo "Giỏ hàng trống"
                                        } else {
                                            $('#cart-subtotal').text(formatter.format(data.total));
                                            $('#cart-grand-total').text(formatter.format(data.total));
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            });
        });
    </script>
}